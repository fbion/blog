<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>ElasticSearch cluster | Shining Moon</title>


<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://blog.monsterxx03.com/css/custom.css'><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://blog.monsterxx03.com"><h1 class="title is-4">Shining Moon</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" aria-label="config" href='#ZgotmplZ' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:xyj.asmy@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="github" href='https://github.com/monsterxx03' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="linkedin" href='https://linkedin.com/in/%e5%be%90-%e5%8f%b6%e4%bd%b3-43564554' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/monsterxx03' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <nav class="nav">
      

      
    </nav>

  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/distribute">#distribute</a>



  
  | <a class="subtitle is-6" href="/tags/elasticsearch">#elasticsearch</a>
  

      
    </div>
    <h2 class="subtitle is-6">March 22, 2017</h2>
    <h1 class="title">ElasticSearch cluster</h1>
    
    <div class="content">
      <p>In this article, let&#8217;s talk about ElasticSearch&#8217;s cluster mode, which means multi nodes ElasticSearch.</p>

<h2 id="basic-concepts">Basic concepts</h2>

<p>cluster: A collection of server nodes with same <code>cluster.name</code> settings in elasticsearch.yaml</p>

<p>primary shards: Divide a index into multi parts(by default 5), shards of an index can be distributed over multi nodes. It enables scale index horizontally and make access to index parallelly(accross multi nodes).</p>

<p>replicas: backup for shards, also replicas can handle search requests, which means you can scale your search capacity horizontally via replicas.</p>

<p></p>

<h2 id="single-node">Single node</h2>

<p>If you setup a single node ES, all shards will be hosted together, and there will be no replicas.</p>

<p>Host replicas and shards on a same node make no sense, they will be lost at same time. If no additional node is available, ES will not allocate replicas.</p>

<p>Get all shards info: <code>curl http://localhost:9200/_cat/shards?v</code></p>

<pre><code>forum                 2     p      STARTED       0  159b 127.0.0.1 dev-host
forum                 2     r      UNASSIGNED
forum                 3     p      STARTED       0  159b 127.0.0.1 dev-host
forum                 3     r      UNASSIGNED
forum                 4     p      STARTED       0  159b 127.0.0.1 dev-host
forum                 4     r      UNASSIGNED
forum                 1     p      STARTED       0  159b 127.0.0.1 dev-host
forum                 1     r      UNASSIGNED
forum                 0     p      STARTED       0  160b 127.0.0.1 dev-host
forum                 0     r      UNASSIGNED
</code></pre>

<p>You can see, by default, a index will have 5 primary shards(symbol <code>p</code>), all replicas(symbol <code>r</code>) are not assigned.</p>

<p>Also cluster status will be yellow, since there&#8217;re no replicas available.</p>

<h2 id="two-nodes">Two nodes</h2>

<p>Let&#8217;s add one node into cluster.</p>

<p>ES have two ways to find other nodes in cluster: multicast and unicast.</p>

<p><code>multicast</code> works via send a UDP ping to local network, in production environment, we should disable it(disabled by default), I think no body will like it.</p>

<p><code>unicast</code> works via provide an initial host list (defined by <code>discovery.zen.ping.unicast.hosts</code>), nodes communite with each other via gossip protocol. So a new node needn&#8217;t know complete list of cluster, it can only talk to a few nodes to get whole cluster info. Some projects like consul and redis cluster also work like this way.</p>

<p>One more thing to care is you need to specify <code>network.publish_host</code> explicitly. By default it will be 127.0.0.1, you need to change it to a ip/host which other nodes can access.</p>

<p><img src="http://blog.monsterxx03.com/wp-content/uploads/2017/05/two-nodes.png" alt="two-nodes-es" /></p>

<p>In two nodes setup, all replicas will be hosted on another host. All write operations to NODE 2 will be forwarded to NODE 1 internally on server. As comparison, redis cluster use so called smart client, server only tell client the right one to query.</p>

<p>With two nodes setup, we can suffer one node down with no data loss. However, network partition will make two nodes brain split.</p>

<p>Each node think another one is down, so it make self be master. At the same time, client&#8217;s write operations still sucess on both. But data will split on two nodes, you will not be aware of it unless search return wired result. So you may come to data inconsistency on two nodes setup.</p>

<p>Cluster status will be green, since all shards will have one replicas.</p>

<h3 id="three-nodes">Three nodes</h3>

<p>Three nodes can suffer network partition. But you need to set <code>discovery.zen.minimum_master_nodes</code> to 2. If one node failed, left two will elect a new master. If two nodes failed, there will not be enough master eligible nodes, client will come to error, so no data inconsistency will happen.</p>

<p><img src="https://blog.monsterxx03.com/wp-content/uploads/2017/05/three-nodes.png" alt="three-nodes-es" /></p>

<p>Picture taken from es official doc, it uses 3 replicas as example.</p>

<h3 id="notes">Notes</h3>

<p>ES has very flexible configuration, you can setup dedicated master eligible node, data only node, ingest only node, tribe noly node based on your size: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html" target="_blank">https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html</a></p>
      
    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'mx03';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>monsterxx03</p>
    
  </div>
</section>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-98667627-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>
</html>

